# 购物车模块文档

## 第一部分：总体逻辑

购物车模块主要负责用户购物车的管理功能，包括以下核心功能：

1. **购物车商品管理**：
   - 添加商品到购物车
   - 更新购物车商品数量
   - 移除购物车商品
   - 清空无效商品

2. **购物车商品选择**：
   - 选择/取消选择单个商品
   - 全选/取消全选商品
   - 移除选中商品

3. **购物车结算**：
   - 计算选中商品总价
   - 跳转到结算页面

### 流程图：购物车模块总体逻辑

```
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│                   │     │                   │     │                   │
│ 购物车商品管理     │     │ 购物车商品选择     │     │   购物车结算      │
│                   │     │                   │     │                   │
└─────────┬─────────┘     └─────────┬─────────┘     └─────────┬─────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ - 添加商品        │     │ - 选择/取消单个    │     │ - 计算选中商品    │
│ - 增加/减少数量   │     │ - 全选/取消全选    │     │   总价           │
│ - 移除商品        │     │ - 移除选中商品     │     │ - 跳转到结算页    │
│ - 清空无效商品    │     │                   │     │                   │
└───────────────────┘     └───────────────────┘     └───────────────────┘
```

## 第二部分：组件到Store的逻辑

购物车模块采用Vue3的组合式API和Pinia状态管理库，实现组件与状态管理的解耦。

### 核心组件

1. **Cart.vue**：
   - 购物车页面主组件
   - 包含商品列表展示
   - 提供商品选择、数量修改、删除等操作
   - 显示结算信息和金额统计

### 状态管理 (useCartStore.js)

状态管理器封装了所有购物车相关操作，包括：

- 购物车商品列表管理
- 商品选择状态管理
- 数量计算与价格统计
- 商品操作（添加、更新、删除）

### 核心状态和计算属性

- **状态**：
  - `items`: 购物车商品列表
  - `selectedIds`: 选中的商品ID集合
  - `loading`: 加载状态

- **计算属性**：
  - `totalCount`: 购物车商品总数量
  - `totalPrice`: 选中商品总价
  - `selectedCount`: 选中商品数量
  - `selectedItems`: 选中的商品列表
  - `isAllSelected`: 是否全选状态

### 数据流向

组件通过Pinia的useCartStore获取状态和方法，Store通过API服务与后端交互。

### 流程图：组件到Store的数据流

```
┌──────────────────────────────────────────┐
│                                          │
│             视图层 (View)                 │
│                                          │
├──────────────────────────────────────────┤
│                                          │
│               Cart.vue                   │
│                                          │
└───────────────────┬──────────────────────┘
                    │
                    │
                    ▼
┌──────────────────────────────────────────┐
│                                          │
│         状态管理 (useCartStore)           │
│                                          │
├─────────────────┬────────────────────────┤
│                 │                        │
│     状态        │          方法          │
│                 │                        │
├─────────────────┼────────────────────────┤
│ - items         │ - toggleSelect()       │
│ - selectedIds   │ - toggleSelectAll()    │
│ - loading       │ - increaseCount()      │
│                 │ - decreaseCount()      │
│                 │ - removeItem()         │
│                 │ - markAsInvalid()      │
│                 │ - fetchCart()          │
│                 │ - clearInvalidItems()  │
│                 │ - removeSelectedItems()│
│                 │                        │
└─────────────────┴──────────┬─────────────┘
                             │
                             │
                             ▼
┌────────────────────────────────────────────┐
│                                            │
│                  API 层                     │
│                                            │
└────────────────────────────────────────────┘
```

## 第三部分：API层

购物车模块的API封装在一个文件中：

1. **cart.js**：处理购物车相关的全部API

### API架构

所有API请求都通过 `request.js` 工具函数封装，统一处理以下功能：
- 请求拦截：添加认证信息
- 响应拦截：统一错误处理
- Mock数据支持：开发环境使用Mock数据

### 真实API与Mock数据

项目同时支持真实API和Mock数据：
- 开发环境默认使用Mock数据
- 通过在请求中设置 `mock: true/false` 可以控制是否使用Mock数据

### Mock实现

- Mock数据实现了所有API的模拟响应
- 在 `src/mock/modules/cart.mock.js` 中定义了所有购物车相关的Mock数据
- 支持模拟真实场景，如错误处理、数据校验等

### 流程图：API调用与Mock处理流程

```
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│                │      │                │      │                │
│  组件/Store    │      │   请求工具     │      │   API服务器    │
│                │      │  request.js    │      │  或Mock服务    │
│                │      │                │      │                │
└────────┬───────┘      └────────┬───────┘      └────────┬───────┘
         │                       │                       │
         │  调用API服务          │                       │
         ├───────────────────────►                       │
         │                       │                       │
         │                       │ 判断是否使用Mock      │
         │                       ├─────────┐             │
         │                       │         │             │
         │                       │ ◄───────┘             │
         │                       │                       │
         │                       │ 如使用真实API         │
         │                       ├───────────────────────►
         │                       │                       │
         │                       │ 如使用Mock            │
         │                       │                       │
         │                       │ ┌──────────────────┐  │
         │                       │ │                  │  │
         │                       │ │  拦截原始请求    │  │
         │                       │ │                  │  │
         │                       │ └─────────┬────────┘  │
         │                       │           │           │
         │                       │           ▼           │
         │                       │ ┌──────────────────┐  │
         │                       │ │                  │  │
         │                       │ │ 处理Mock数据响应 │  │
         │                       │ │                  │  │
         │                       │ └─────────┬────────┘  │
         │                       │           │           │
         │                       │ ◄─────────┘           │
         │                       │                       │
         │  响应结果             │                       │
         ◄───────────────────────┤                       │
         │                       │                       │
         │                       │                       │
┌────────┴───────┐      ┌────────┴───────┐      ┌────────┴───────┐
│                │      │                │      │                │
│  组件/Store    │      │   请求工具     │      │   API服务器    │
│  处理响应      │      │  request.js    │      │  或Mock服务    │
│                │      │                │      │                │
└────────────────┘      └────────────────┘      └────────────────┘
```

## 核心API列表

### 购物车API (cart.js)
- `fetchCart()` - 获取购物车列表
- `addItem(skuId, count, goodsId, goodsDetail, skuInfo)` - 添加商品到购物车
- `batchUpdate(updates)` - 批量更新购物车商品 