# 订单模块文档

## 第一部分：总体逻辑

订单模块主要负责订单的创建、查询和管理功能，包括以下核心功能：

1. **订单创建与结算**：
   - 从购物车创建订单
   - 选择收货地址
   - 填写订单备注
   - 提交订单并跳转支付

2. **订单支付**：
   - 支付方式选择
   - 支付状态处理
   - 支付结果回调

3. **订单管理**：
   - 订单列表查询
   - 订单详情查看
   - 订单状态跟踪
   - 订单操作（取消订单、确认收货）
   - 物流信息查询

### 流程图：订单模块总体逻辑

```
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│                   │     │                   │     │                   │
│  订单创建与结算    │     │    订单支付        │     │    订单管理        │
│                   │     │                   │     │                   │
└─────────┬─────────┘     └─────────┬─────────┘     └─────────┬─────────┘
          │                         │                         │
          ▼                         ▼                         ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ - 从购物车创建     │     │ - 支付方式选择    │     │ - 订单列表查询    │
│ - 选择收货地址     │     │ - 支付状态处理    │     │ - 订单详情查看    │
│ - 填写订单备注     │     │ - 支付结果回调    │     │ - 订单状态跟踪    │
│ - 提交订单         │     │                   │     │ - 订单操作        │
│                   │     │                   │     │ - 物流信息查询    │
└───────────────────┘     └───────────────────┘     └───────────────────┘
```

## 第二部分：组件到Store的逻辑

订单模块采用Vue3的组合式API和Pinia状态管理库，实现组件与状态管理的解耦。

### 核心组件

1. **Checkout.vue**：
   - 订单结算页面组件
   - 显示订单商品列表
   - 提供收货地址选择
   - 支持添加订单备注
   - 计算订单金额

2. **Pay.vue**：
   - 支付页面组件
   - 显示订单金额
   - 提供支付方式选择
   - 处理支付结果

3. **OrderDetail.vue**：
   - 订单详情页面组件
   - 显示订单状态、商品、金额等信息
   - 显示物流信息
   - 提供订单操作按钮

### 状态管理 (useOrderStore.js)

状态管理器封装了所有订单相关操作，包括：

- 订单数据管理
- 订单列表和详情查询
- 订单状态更新
- 订单操作实现（取消、确认收货）

### 核心状态和计算属性

- **状态**：
  - `currentOrder`: 当前订单
  - `orderList`: 订单列表
  - `loading`: 加载状态

- **计算属性**：
  - `orderStatusText`: 订单状态文本映射

### 数据流向

组件通过Pinia的useOrderStore获取状态和方法，Store通过API服务与后端交互。

### 流程图：组件到Store的数据流

```
┌───────────────────────────────────────────────┐
│                                               │
│                视图层 (View)                   │
│                                               │
├─────────────┬─────────────┬───────────────────┤
│             │             │                   │
│  Checkout   │    Pay      │   OrderDetail     │
│             │             │                   │
└─────┬───────┴──────┬──────┴────────┬──────────┘
      │              │               │
      │              │               │
      ▼              ▼               ▼
┌─────────────────────────────────────────────────┐
│                                                 │
│            状态管理 (useOrderStore)              │
│                                                 │
├─────────────────┬───────────────────────────────┤
│                 │                               │
│     状态        │          方法                 │
│                 │                               │
├─────────────────┼───────────────────────────────┤
│ - currentOrder  │ - submitOrder()               │
│ - orderList     │ - getOrderDetail()            │
│ - loading       │ - getOrderList()              │
│                 │ - cancelOrder()               │
│                 │ - confirmReceipt()            │
│                 │ - clearCurrentOrder()         │
│                 │                               │
└─────────────────┴─────────────┬─────────────────┘
                                │
                                │
                                ▼
┌──────────────────────────────────────────────────┐
│                                                  │
│                      API 层                       │
│                                                  │
└──────────────────────────────────────────────────┘
```

## 第三部分：API层

订单模块的API封装在一个文件中：

1. **order.js**：处理订单相关的全部API

### API架构

所有API请求都通过 `request.js` 工具函数封装，统一处理以下功能：
- 请求拦截：添加认证信息
- 响应拦截：统一错误处理
- Mock数据支持：开发环境使用Mock数据

### 真实API与Mock数据

项目同时支持真实API和Mock数据：
- 开发环境默认使用Mock数据
- 通过在请求中设置 `mock: true/false` 可以控制是否使用Mock数据

### Mock实现

- Mock数据实现了所有API的模拟响应
- 在 `src/mock/modules/order.mock.js` 中定义了所有订单相关的Mock数据
- 支持模拟订单各种状态和操作
- 实现了订单创建、支付、取消、确认收货等完整流程

### 流程图：API调用与Mock处理流程

```
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│                │      │                │      │                │
│  组件/Store    │      │   请求工具     │      │   API服务器    │
│                │      │  request.js    │      │  或Mock服务    │
│                │      │                │      │                │
└────────┬───────┘      └────────┬───────┘      └────────┬───────┘
         │                       │                       │
         │  调用API服务          │                       │
         ├───────────────────────►                       │
         │                       │                       │
         │                       │ 判断是否使用Mock      │
         │                       ├─────────┐             │
         │                       │         │             │
         │                       │ ◄───────┘             │
         │                       │                       │
         │                       │ 如使用真实API         │
         │                       ├───────────────────────►
         │                       │                       │
         │                       │ 如使用Mock            │
         │                       │                       │
         │                       │ ┌──────────────────┐  │
         │                       │ │                  │  │
         │                       │ │  拦截原始请求    │  │
         │                       │ │                  │  │
         │                       │ └─────────┬────────┘  │
         │                       │           │           │
         │                       │           ▼           │
         │                       │ ┌──────────────────┐  │
         │                       │ │                  │  │
         │                       │ │ 处理Mock数据响应 │  │
         │                       │ │                  │  │
         │                       │ └─────────┬────────┘  │
         │                       │           │           │
         │                       │ ◄─────────┘           │
         │                       │                       │
         │  响应结果             │                       │
         ◄───────────────────────┤                       │
         │                       │                       │
         │                       │                       │
┌────────┴───────┐      ┌────────┴───────┐      ┌────────┴───────┐
│                │      │                │      │                │
│  组件/Store    │      │   请求工具     │      │   API服务器    │
│  处理响应      │      │  request.js    │      │  或Mock服务    │
│                │      │                │      │                │
└────────────────┘      └────────────────┘      └────────────────┘
```

## 核心API列表

### 订单API (order.js)
- `createOrder(items, address, options)` - 创建订单
- `fetchOrder(orderNo)` - 获取订单详情
- `fetchOrderList(params)` - 获取订单列表
- `cancelOrder(orderNo)` - 取消订单
- `confirmReceipt(orderNo)` - 确认收货
- `fetchLogistics(orderNo)` - 获取物流信息 