# 用户模块文档

## 第一部分：总体逻辑

用户模块主要负责用户的身份验证与个人信息管理功能，包括以下核心功能：

1. **身份验证**：
   - 用户登录（支持账号密码和短信验证码两种方式）
   - 用户注册
   - 验证码生成与验证
   - 登出功能

2. **个人信息管理**：
   - 用户资料查看与编辑
   - 头像上传与更新
   - 密码修改

3. **收货地址管理**：
   - 地址列表查询
   - 添加新地址
   - 编辑已有地址
   - 设置默认地址
   - 删除地址

### 流程图：用户模块总体逻辑

```
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│                  │     │                  │     │                  │
│  身份验证模块     │     │  个人信息管理     │     │  收货地址管理     │
│                  │     │                  │     │                  │
└────────┬─────────┘     └────────┬─────────┘     └────────┬─────────┘
         │                        │                        │
         ▼                        ▼                        ▼
┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐
│ - 账号密码登录    │     │ - 查看个人资料    │     │ - 查询地址列表    │
│ - 短信验证码登录  │     │ - 编辑个人资料    │     │ - 添加新地址      │
│ - 用户注册       │     │ - 上传/更新头像   │     │ - 编辑已有地址    │
│ - 验证码处理     │     │ - 修改密码       │     │ - 设置默认地址    │
│ - 登出功能       │     │                  │     │ - 删除地址        │
└──────────────────┘     └──────────────────┘     └──────────────────┘
```

## 第二部分：组件到Store的逻辑

用户模块采用Vue3的组合式API和Pinia状态管理库，实现组件与状态管理的解耦。

### 核心组件

1. **Login.vue**：
   - 支持账号密码登录和短信验证码登录两种方式
   - 包含验证码生成与验证
   - 登录后将用户信息存储到Pinia状态中

2. **Register.vue**：
   - 用户注册表单及逻辑
   - 包含手机验证与图形验证码
   - 注册成功后自动登录

3. **Profile.vue**：
   - 个人信息展示与编辑
   - 地址管理（列表、添加、编辑、删除）
   - 头像上传与预览

### 状态管理 (useUserStore.js)

状态管理器封装了所有用户相关操作，包括：

- 用户登录状态管理
- 用户信息的本地存储与持久化
- 地址管理的CRUD操作
- 个人信息更新

### 数据流向

组件通过Pinia的useUserStore获取状态和方法，Store通过API服务与后端交互。

### 流程图：组件到Store的数据流

```
┌───────────────────────────────────────────┐
│                                           │
│                视图层 (View)               │
│                                           │
├───────────┬─────────────┬─────────────────┤
│           │             │                 │
│  Login    │  Register   │     Profile     │
│           │             │                 │
└─────┬─────┴──────┬──────┴────────┬────────┘
      │            │               │
      │            │               │
      ▼            ▼               ▼
┌─────────────────────────────────────────────┐
│                                             │
│          状态管理 (useUserStore)             │
│                                             │
├─────────────────┬───────────────────────────┤
│                 │                           │
│    用户状态      │         方法              │
│                 │                           │
├─────────────────┼───────────────────────────┤
│ - token         │ - login()                 │
│ - userProfile   │ - logout()                │
│ - userInfo      │ - loadUserInfo()          │
│ - addresses     │ - updateUserInfo()        │
│                 │ - loadAddresses()         │
│                 │ - addAddress()            │
│                 │ - updateAddress()         │
│                 │ - setDefaultAddress()     │
│                 │ - removeAddress()         │
│                 │ - updateAvatar()          │
│                 │                           │
└─────────────────┴───────────┬───────────────┘
                              │
                              │
                              ▼
┌──────────────────────────────────────────────┐
│                                              │
│                  API 层                       │
│                                              │
└──────────────────────────────────────────────┘
```

## 第三部分：API层

用户模块的API层分为三个主要文件：

1. **auth.js**：处理身份验证相关API
2. **profile.js**：处理用户资料相关API
3. **address.js**：处理地址管理相关API

### API架构

所有API请求都通过 `request.js` 工具函数封装，统一处理以下功能：
- 请求拦截：添加认证信息
- 响应拦截：统一错误处理
- Mock数据支持：开发环境使用Mock数据

### 真实API与Mock数据

项目同时支持真实API和Mock数据：
- 开发环境默认使用Mock数据
- 通过在请求中设置 `mock: true/false` 可以控制是否使用Mock数据

### Mock实现

- Mock数据实现了所有API的模拟响应
- 在 `src/mock/modules/user.mock.js` 中定义了所有用户相关的Mock数据
- 支持模拟真实场景，如错误处理、数据校验等

### 流程图：API调用与Mock处理流程

```
┌────────────────┐      ┌────────────────┐      ┌────────────────┐
│                │      │                │      │                │
│  组件/Store    │      │   请求工具     │      │   API服务器    │
│                │      │  request.js    │      │  或Mock服务    │
│                │      │                │      │                │
└────────┬───────┘      └────────┬───────┘      └────────┬───────┘
         │                       │                       │
         │  调用API服务          │                       │
         ├───────────────────────►                       │
         │                       │                       │
         │                       │ 判断是否使用Mock      │
         │                       ├─────────┐             │
         │                       │         │             │
         │                       │ ◄───────┘             │
         │                       │                       │
         │                       │ 如使用真实API         │
         │                       ├───────────────────────►
         │                       │                       │
         │                       │ 如使用Mock            │
         │                       │                       │
         │                       │ ┌──────────────────┐  │
         │                       │ │                  │  │
         │                       │ │  拦截原始请求    │  │
         │                       │ │                  │  │
         │                       │ └─────────┬────────┘  │
         │                       │           │           │
         │                       │           ▼           │
         │                       │ ┌──────────────────┐  │
         │                       │ │                  │  │
         │                       │ │ 处理Mock数据响应 │  │
         │                       │ │                  │  │
         │                       │ └─────────┬────────┘  │
         │                       │           │           │
         │                       │ ◄─────────┘           │
         │                       │                       │
         │  响应结果             │                       │
         ◄───────────────────────┤                       │
         │                       │                       │
         │                       │                       │
┌────────┴───────┐      ┌────────┴───────┐      ┌────────┴───────┐
│                │      │                │      │                │
│  组件/Store    │      │   请求工具     │      │   API服务器    │
│  处理响应      │      │  request.js    │      │  或Mock服务    │
│                │      │                │      │                │
└────────────────┘      └────────────────┘      └────────────────┘
```

## 核心API列表

### 身份验证 (auth.js)
- `loginByPassword(username, password, captcha, captchaId)` - 账号密码登录
- `loginBySMS(mobile, smsCode, captcha, captchaId)` - 短信验证码登录
- `getCaptchaImage()` - 获取图形验证码
- `verifyCaptcha(captcha, captchaId)` - 验证图形验证码
- `register(userData)` - 用户注册

### 用户资料 (profile.js)
- `getUserProfile()` - 获取用户个人资料
- `updateUserProfile(profileData)` - 更新用户个人资料
- `updateUserAvatar(formData)` - 上传用户头像
- `changePassword(oldPassword, newPassword)` - 修改密码

### 地址管理 (address.js)
- `getAddressList()` - 获取地址列表
- `addAddress(addressData)` - 新增地址
- `updateAddress(id, addressData)` - 更新地址
- `setDefaultAddress(id)` - 设置默认地址
- `deleteAddress(id)` - 删除地址
